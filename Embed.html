
<!DOCTYPE html>
<html>
  <head>
    <title>Map App</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.3.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
    <style>
     	#map {
        	position: relative;
        	height: 100%;
        	width: 100%;
      	}

      	.popover{
    		min-width: 280px;
		}*/
    </style>
  	</head>
  	<body>
    <div id="map" class="map"><div id="popup"></div></div>
    <script>

    	/* Based off of https://openlayers.org/en/latest/examples/geojson.html*/
    	
    var styles = {
        'Point': new ol.style.Style({
          	image: new ol.style.Circle({
            	fill: new ol.style.Fill({
              		color: 'Aqua'
            	}),
            	radius: 4,
            	stroke: new ol.style.Stroke({
              		color: 'blue',
              		width: 2
            	})
         	})
        }),
        'LineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'black',
            width: 2
          })
        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'green',
            width: 1
          })
        }),
        'MultiPoint': new ol.style.Style({
          	image: new ol.style.Circle({
            	fill: new ol.style.Fill({
              		color: 'rgba(255,255,0,0.5)'
            	}),
            	radius: 5,
            	stroke: new ol.style.Stroke({
              		color: '#ff0',
              		width: 1
            	})
         	})
        }),
        'MultiPolygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'yellow',
            width: 1
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 0, 0.1)'
          })
        }),
        'Polygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'blue',
            lineDash: [4],
            width: 3
          }),
          fill: new ol.style.Fill({
            color: 'rgba(0, 0, 255, 0.1)'
          })
        }),
        'GeometryCollection': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'magenta',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'magenta'
          }),
          image: new ol.style.Circle({
            radius: 10,
            fill: null,
            stroke: new ol.style.Stroke({
              color: 'magenta'
            })
          })
        }),
        'Circle': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'red',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255,0,0,0.2)'
          })
        })
      };

    	

  	function labelStyleFunction(feature, resolution) {
    	return new ol.style.Style({
      		text: new ol.style.Text({
      			text: feature.get('la_name'),
      			font:'16px Arial',
      			fill: new ol.style.Fill({color: 'black'}),
				stroke: new ol.style.Stroke({color: 'white', width: 3}),
				offsetX: 10,
				offsetY: 15
      		})
    	});
      }

  	var labels = new ol.layer.Vector({
    	source: new ol.source.Vector({
      		url: 'kmlconv.geojson',
      		format: new ol.format.GeoJSON()
    	}),
    	style: labelStyleFunction
  	});

  	var styleFunction = function(feature, resolution){
  		return styles[feature.getGeometry().getType()];
  	};

  	var locations = new ol.layer.Vector({
      	source: new ol.source.Vector({
        	url: 'kmlconv.geojson',
        	format: new ol.format.GeoJSON(),
   		}),
 		style: styleFunction
  	});

  	
  	var map = new ol.Map({
    	layers: [
    		new ol.layer.Tile({
        		 source: new ol.source.XYZ({
              urls:
              [
                "http://a.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://b.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://c.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://d.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png"
              ],
              crossOrigin: 'anonymous'
            })
      		}),
    		locations,
    		labels
    	],
    	target:  document.getElementById('map'),
    	//Would like to change this to be automatic
    	view: new ol.View({
    		center: ol.proj.transform([28.32, 34.2], 'EPSG:4326', 'EPSG:3857'),
    		zoom: 6
    	})
 	 });


  	/*Using https://openlayers.org/en/latest/examples/icon.html */
  	var element = document.getElementById('popup');

  	var popup = new ol.Overlay({
    	element: element,
    	stopEvent: false,
    	autoPan: true,
    	autoPanAnimation: {
          duration: 250
        },
    	offset: [0, -10]
  	});
  	map.addOverlay(popup);

    // display popup on click
    map.on('click', function(evt) {
        var feature = map.forEachFeatureAtPixel(evt.pixel,
            function(feature) {
              	return feature;
            });
        if (feature) {
          	var coordinates = feature.getGeometry().getCoordinates();
         	popup.setPosition(coordinates);
          	$(element).popover({
            	'placement': 'top',
            	'html': true,
            	'content': feature.get('passage')
          	});
          $(element).popover('show');
        } else {
          $(element).popover('destroy');
        }
      });

      // change mouse cursor when over marker
      map.on('pointermove', function(e) {
        if (e.dragging) {
          $(element).popover('destroy');
          return;
        }
        var pixel = map.getEventPixel(e.originalEvent);
        var hit = map.hasFeatureAtPixel(pixel);
        map.getTarget().style.cursor = hit ? 'pointer' : '';
      });

      
    </script>
  </body>
</html>