<!DOCTYPE html>
<html>
  <head>
    <title>Map Creator</title>
    <link rel="stylesheet" href="https://openlayers.org/en/v4.4.2/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script></script>
    <script src="https://openlayers.org/en/v4.4.2/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.3/FileSaver.min.js"></script>
    <style>
      .map {
        position: absolute;
        top: 0;
        bottom: 0;
        left: 0;
        right: 20%;
        font-family: Arial, sans-serif;
      }

      .sidebar {
          position: absolute;
          top: 0;
          bottom: 0;
          right: 0;
          width: 20%;
          background: ghostwhite;
          border-left: 5px solid lightsteelblue;
          box-sizing: border-box;
          padding: 0 20px;
          font-family: Arial, sans-serif;
      }

      .controls {
        list-style: none;
        padding: 10px;
      }

      .controls li {
        margin: 0 0 5px 5px;  
      } 

      #js-textarea{
        width: 100%;
        height: 375px;
      }

      .ol-mouse-position {
        top: inherit;
        bottom: 8px;
        left: 8px;
        background-color: rgba(255,255,255,0.4);
        border-radius: 2px;
        width: 100px;
        text-align: center;
        font-family: Arial, sans-serif;
        font-size: 15px;
      }
    
      .buttons .ol-control button.active {
        background-color: rgba(234,129,8,1);
      }

      .buttons .ol-control button.active:hover {
        background-color: rgba(234,129,8,1);
      }

      .buttons .ol-addpoint button {
        background-image: url(./res/button_draw.png);
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
      <div id="buttons" class="buttons"></div>
    <div class="sidebar">
      <ul  class="controls">
        <li>
          <form class="form-inline">
            <label>Geometry type</label>
              <select id="type">
                <option value="None">None</option>
                <option value="Point">Point</option>
                <option value="LineString">Directional Line</option>
                <option value="MultiLineString">Line</option>
              </select>
            </label>
          </form>
        </li>
        <li>
           Lat:<input type="text" name="latitude" id="lat"><br>
           Long:<input type="text" name="longitude" id="long"><br>
            <button id="create" class="btn btn-default">Create Feature</button>
        </li>
        <li>
           Label Text:<input type="text" name="labelText" id="lab"><br>
            <button id="createLabel" class="btn btn-default">Create Label </button>
        </li>
        <li>
          <form class="form-inline">
            <label>Icon</label><br>
              <select id="icon">
                <option value="">None</option>
                <option value="test">Test</option>
                <option value="test2">Test2</option>
              </select>
            </label>
          </form>
          <button id="createIcon" class="btn btn-default">Create Icon </button>
        </li>
        <li>
          <button id="delete" class="btn btn-default">Delete Feature</button>
        </li>
        <li>
          <button id="edit" class="btn btn-default" data-target="#edit-modal" data-toggle="modal">Edit GeoJSON String</button> 
        </li>
        <li>
          <button id="save" class="btn btn-default">Save GeoJSON</button> 
        </li>
        <li>
          <a id="export-png" class="btn btn-default"><i class="fa fa-download"></i> Download PNG</a>
        </li>
      </ul>
    </div>
   
    <div id="edit-modal" class="modal fade" role="dialog">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title">Edit GeoJSON</h4>
          </div>
          <div class="modal-body">
            <textarea id="js-textarea"></textarea>
            
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" id="edit-save">Save File</button>
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
    <script>


    styles = {
        'Point': new ol.style.Style({
            image: new ol.style.Circle({
              fill: new ol.style.Fill({
                  color: 'white'
              }),
              radius: 3,
              stroke: new ol.style.Stroke({
                  color: 'black',
                  width: 2
              })
          })
        }),
        'LineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'black',
            width: 2
          })

        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'green',
            width: 1
          })
        }),
        'MultiPoint': new ol.style.Style({
            image: new ol.style.Circle({
              fill: new ol.style.Fill({
                  color: 'black'
              }),
              radius: 5,
              stroke: new ol.style.Stroke({
                  color: '#ff0',
                  width: 1
              })
          })
        }),
        'MultiPolygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'yellow',
            width: 1
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255, 255, 0, 0.1)'
          })
        }),
        'Polygon': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'blue',
            lineDash: [4],
            width: 3
          }),
          fill: new ol.style.Fill({
            color: 'rgba(0, 0, 255, 0.1)'
          })
        }),
        'GeometryCollection': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'magenta',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'magenta'
          }),
          image: new ol.style.Circle({
            radius: 10,
            fill: null,
            stroke: new ol.style.Stroke({
              color: 'magenta'
            })
          })
        }),
        'Circle': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: 'red',
            width: 2
          }),
          fill: new ol.style.Fill({
            color: 'rgba(255,0,0,0.2)'
          })
        })
      };
      
    var styleFunction = function(feature, resolution){
      if (feature.getGeometry().getType() == 'LineString'){
        var geometry = feature.getGeometry();
        var lineStyles = [
          // linestring
          new ol.style.Style({
            stroke: new ol.style.Stroke({
              color: 'black',
              width: 1
            })
          })
        ];

       geometry.forEachSegment(function(start, end) {
          var dx = end[0] - start[0];
          var dy = end[1] - start[1];
          var len =Math.sqrt(Math.pow(dx,2) + Math.pow(dy,2)); 
          var rotation = Math.atan2(dy, dx);
          var xAve = (start[0] + end[0])/2;
          var yAve = (start[1] + end[1])/2;
          mid = [xAve,yAve];
        
          // arrows
          if(len > 150000){ //only longer lines get arrows
            lineStyles.push(new ol.style.Style({
              geometry: new ol.geom.Point(mid),
              image: new ol.style.Icon({
                src: 'arrow.png',
                anchor: [0.75, 0.5],
                rotateWithView: true,
                rotation: -rotation,
                scale: 0.65
              })
            }));
          };
        });
        return lineStyles;
      } else {
        return styles[feature.getGeometry().getType()];
      };
    };

    function labelStyleFunction(feature, resolution) {
      if (feature.get('la_name') != 'None'){//may not be necessary
        return new ol.style.Style({
            text: new ol.style.Text({
              text: feature.get('la_name'),
              font:'16px Arial',
              fill: new ol.style.Fill({color: 'black'}),
          stroke: new ol.style.Stroke({color: 'white', width: 5}),
            })
        });
      }
    }

    function iconStyleFunction(feature, resolution) {
      return new ol.style.Style({
        image: new ol.style.Icon(/** @type {olx.style.IconOptions} */ ({
          src: feature.get('icon_path')
        }))
      });
    }


      /* Beggining of Drawing */

      var labelSource = new ol.source.Vector({
      }); 

      var labelVector = new ol.layer.Vector({ 
        source: labelSource,    
        style: labelStyleFunction
        });

      var iconSource = new ol.source.Vector({
      }); 

      var iconVector = new ol.layer.Vector({ 
        source: iconSource,    
        style: iconStyleFunction
        });

      var source = new ol.source.Vector({
      }); 

      var vector = new ol.layer.Vector({ 
        source: source,    
        style: styleFunction
        });
      /*Map*/

      var raster = new ol.layer.Tile({
        source: new ol.source.XYZ({
              urls:
              [
                "http://a.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://b.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://c.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png",
                "http://d.tiles.mapbox.com/v3/isawnyu.map-knmctlkh/{z}/{x}/{y}.png"
              ],
              crossOrigin: 'anonymous'
            })
      });

      var map = new ol.Map({
        layers: [ raster, vector, iconVector, labelVector],
        target: 'map',
        view: new ol.View({
          projection: 'EPSG:3857',
          center: [-32, 20],
          zoom: 3
        })
      });

      // idea from opoenLayers 3.x Cookbook by Peter J. Langley, Antonio Santiago Perez
      var mousePositionControl = new ol.control.MousePosition({
        coordinateFormat: ol.coordinate.createStringXY(2),
        projection: 'EPSG:4326'
      });

      map.addControl(mousePositionControl)
      /*start of drawing*/
     

      var draw, snap, labelDraw; // global so we can remove them later
      var featureTypeselect = document.getElementById('type');
      
      
      var select_interaction = null;
      var modify = null;
      var select = null;
      var featureID = 0;
      var selectedFeatureID;
      var selectedLayer = vector;

      function addFeatureInteractions() {
        var value = featureTypeselect.value;
        if (value !== 'None'){ //will have to add seperate ifs for types
          draw = new ol.interaction.Draw({
            source: source,
            type: /** @type {ol.geom.GeometryType} */ (featureTypeselect.value)
          });

          draw.on('drawend', function (event) {
            featureID = featureID + 1;
            event.feature.setProperties({
                'id': featureID
            })
         })
          map.addInteraction(draw);
        } else {
            select_interaction = new ol.interaction.Select({
              wrapX: false,
              hitTolerance: 10
            });
            map.addInteraction(select_interaction);

            select_interaction.getFeatures().on('add', function (event) {
              var properties = event.element.getProperties();
              selectedFeatureID = properties.id;
       
            });
             

            modify = new ol.interaction.Modify({
              features: select_interaction.getFeatures()
            });

            map.addInteraction(modify);
        }
        snap = new ol.interaction.Snap({source: source});
        map.addInteraction(snap);
      }

      /**
       * Handle change event.
       */
      featureTypeselect.onchange = function() {
        map.removeInteraction(draw);
        map.removeInteraction(snap);
        map.removeInteraction(select_interaction);
        select_interaction = null;
        map.removeInteraction(modify);
        modify = null;
        addFeatureInteractions();
      };
      /*End of Draw*/
      addFeatureInteractions();

      // put these together
      function removeInteractions(){
        map.removeInteraction(draw);
        map.removeInteraction(snap);
        map.removeInteraction(select_interaction);
        select_interaction = null;
        map.removeInteraction(modify);
        modify = null;
      }

      function resetType() {
        $("#type").each(function() { this.selectedIndex = 0 });
        removeInteractions();
      }

      map.on('click', function(evt) {
        map.forEachLayerAtPixel(evt.pixel, function(layer){ 
          if(layer===labelVector) {
            selectedLayer = labelVector;
            console.log("label");
          } 
          if(layer===vector){
            selectedLayer = vector;
            console.log("vector");
          }
          if(layer===iconVector){
            selectedLayer = iconVector;
            console.log("icon vector");
          }
        });
      });   


      /*
       *Start of drag and drop
       */

      var dragAndDropInteraction = new ol.interaction.DragAndDrop({
        formatConstructors: [
          ol.format.GPX,
          ol.format.GeoJSON,
          ol.format.IGC,
          ol.format.KML,
          ol.format.TopoJSON
        ]
      });

      map.addInteraction(dragAndDropInteraction);

      dragAndDropInteraction.on('addfeatures', function(event) {
        var features = event.features;
        if (features != null && features.length > 0) {
          for (x in features){
            featureID = featureID + 1;
              features[x].setProperties({
                    'id': featureID
              })
          }
        }
        source.addFeatures(features);     
      });


      function deleteFeature() {
        var features = selectedLayer.getSource().getFeatures();
        if (features != null && features.length > 0) {
         for (x in features) {
            var properties = features[x].getProperties();
            var id = properties.id;
            if (id == selectedFeatureID) {
              selectedLayer.getSource().removeFeature(features[x]);
               break;
            }
          }
        }
      };
  
      //must validate
      $("#createLabel").click(function() {
        var name = document.getElementById('lab').value;
        resetType();
        labelDraw = new ol.interaction.Draw({
          source: labelSource,
          type: /** @type {ol.geom.GeometryType} */ ('Point')
        });

        labelDraw.on('drawend', function (event) {
          featureID = featureID + 1;
          event.feature.setProperties({
              'id': featureID,
              'la_name': name
          })
          map.removeInteraction(labelDraw);
          removeInteractions();
          addFeatureInteractions();
        })
        map.addInteraction(labelDraw);
        document.getElementById('lab').value = '';
      });

      //must validate
      $("#createIcon").click(function() {
        var icon = './res/'+document.getElementById('icon').value + '.png';
        resetType();
        iconDraw = new ol.interaction.Draw({
          source: iconSource,
          type: /** @type {ol.geom.GeometryType} */ ('Point')
        });

        iconDraw.on('drawend', function (event) {
          featureID = featureID + 1;
          event.feature.setProperties({
              'id': featureID,
              'icon_path': icon
          })
          map.removeInteraction(iconDraw);
          removeInteractions();
          addFeatureInteractions();
        })
        map.addInteraction(iconDraw);
      });



    //will not work if it does not have an id
     $("#delete").click(function() {
        deleteFeature(); 
        map.removeInteraction(select_interaction); 
        addFeatureInteractions();  
      });
 
      

      /*start of export*/
      document.getElementById('export-png').addEventListener('click', function() {
        map.once('postcompose', function(event) {
          var canvas = event.context.canvas;
          if (navigator.msSaveBlob) {
            navigator.msSaveBlob(canvas.msToBlob(), 'map.png');
          } else {
            canvas.toBlob(function(blob) {
              saveAs(blob, 'map.png');
            });
          }
        });
        map.renderSync();
      });

      //brings up modal
      $("#edit").click(function() {
        var features = [];
        source.forEachFeature(function(feature) {
            var clone = feature.clone();
            clone.getGeometry().transform('EPSG:3857', 'EPSG:4326');
            features.push(clone);
          });
        var geojsonStr = new ol.format.GeoJSON().writeFeatures(features);
        document.getElementById('js-textarea').value = geojsonStr;
      });

      //for the modal
      $("#edit-save").click(function() {
        var geojsonStr = document.getElementById('js-textarea').value;
        var file = new File([geojsonStr], "features.geojson",{type: "text/plain;charset=utf-8"});
        saveAs(file);
      });

      //save button
      $("#save").click(function() {
        var writer = new ol.format.GeoJSON({
          defaultDataProjection:'EPSG:4326'
        });
        var geojsonStr =  writer.writeFeatures(source.getFeatures());
        var file = new File([geojsonStr], "features.geojson",{type: "text/plain;charset=utf-8"});
        saveAs(file);
      });


      //needs validation
      $("#create").click(function(){
        var lat = parseFloat(document.getElementById('lat').value);
        var long = parseFloat(document.getElementById('long').value);
        console.log(long + ' ' + lat);

        var coordinate = new ol.proj.fromLonLat([long, lat]);
        var newFeature = new ol.Feature({
          geometry: new ol.geom.Point(coordinate)
        });

        source.addFeature(newFeature);
        
        document.getElementById('lat').value = '';
        document.getElementById('long').value = '';
      });

    </script>
  </body>
</html>